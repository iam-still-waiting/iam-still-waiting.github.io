<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoiceHub Pro // Admin Command</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --accent: #f43f5e;
            --admin: #eab308;
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --glass: rgba(30, 41, 59, 0.95);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            background: #0b0f19; color: var(--text-main);
            font-family: 'Inter', system-ui, sans-serif;
            height: 100dvh; margin: 0; display: flex; flex-direction: column; overflow: hidden;
        }

        .hidden { display: none !important; }

        /* --- CUSTOM MODAL SYSTEM --- */
        #modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 2000; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.2s;
        }
        #modal-overlay.active { opacity: 1; pointer-events: all; }
        
        .custom-box {
            background: var(--bg-panel); width: 90%; max-width: 400px;
            border: 1px solid var(--border); border-radius: 16px; padding: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); transform: scale(0.95); transition: 0.2s;
        }
        #modal-overlay.active .custom-box { transform: scale(1); }
        
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .modal-body { font-size: 14px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }

        /* --- BUTTONS --- */
        button {
            background: var(--bg-panel); border: 1px solid var(--border); color: var(--text-main);
            padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        button:hover { background: var(--border); transform: translateY(-1px); }
        button:active { transform: scale(0.98); }
        
        button.primary { background: var(--primary); border-color: var(--primary); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        button.primary:hover { background: var(--primary-dark); }
        
        button.danger { background: rgba(244, 63, 94, 0.1); border-color: var(--accent); color: var(--accent); }
        button.danger:hover { background: var(--accent); color: white; }
        
        button.admin-gold { background: rgba(234, 179, 8, 0.1); border-color: var(--admin); color: var(--admin); }
        button.admin-gold:hover { background: var(--admin); color: black; }

        input {
            background: #0f172a; border: 1px solid var(--border); color: white;
            padding: 12px; width: 100%; border-radius: 8px; margin-bottom: 15px; font-size: 14px;
        }
        input:focus { border-color: var(--primary); }

        /* --- UI LAYOUT --- */
        #lobby {
            position: fixed; inset: 0; background: radial-gradient(circle at top, #1e293b, #0b0f19);
            z-index: 100; display: flex; align-items: center; justify-content: center;
        }
        .lobby-card {
            width: 380px; background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(10px);
            padding: 32px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1);
        }

        .toggle-capsule {
            background: #0f172a; padding: 4px; border-radius: 8px; display: flex; margin-bottom: 20px;
        }
        .toggle-opt { flex: 1; text-align: center; padding: 8px; font-size: 12px; border-radius: 6px; cursor: pointer; color: var(--text-muted); }
        .toggle-opt.active { background: var(--primary); color: white; font-weight: 700; }

        #app-layout { display: flex; flex-direction: column; height: 100%; }
        
        #top-bar {
            height: 64px; background: var(--glass); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }

        .status-badge {
            font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            padding: 4px 8px; border-radius: 4px; display: flex; align-items: center; gap: 5px;
        }
        .status-rec { background: rgba(244, 63, 94, 0.2); color: var(--accent); border: 1px solid var(--accent); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* Admin Toolbar */
        .admin-bar {
            background: #0f172a; padding: 8px 16px; border-bottom: 1px solid var(--border);
            display: flex; gap: 10px; align-items: center; overflow-x: auto;
        }
        .admin-label { font-size: 10px; font-weight: 700; color: var(--admin); margin-right: 5px; text-transform: uppercase; }

        #grid {
            flex: 1; padding: 20px; overflow-y: auto;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px; align-content: start;
        }

        /* User Nodes */
        .node {
            background: var(--bg-panel); border: 1px solid var(--border); border-radius: 16px;
            aspect-ratio: 1; position: relative; display: flex; flex-direction: column;
            align-items: center; justify-content: center; overflow: hidden; transition: 0.3s;
        }
        .node.admin-node { border-color: var(--admin); box-shadow: 0 0 15px rgba(234, 179, 8, 0.1); }
        .node.speaking { border-color: var(--primary); box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }

        .avatar {
            width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #475569, #1e293b);
            display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 2; margin-bottom: 10px;
        }

        .node-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
            opacity: 0; transition: 0.2s; backdrop-filter: blur(2px);
        }
        .node:hover .node-overlay { opacity: 1; }

        #controls {
            padding: 20px; background: var(--glass); border-top: 1px solid var(--border);
            display: flex; justify-content: center; gap: 12px;
        }
        .icon-btn { width: 50px; height: 50px; padding: 0; border-radius: 16px; font-size: 18px; }

    </style>
</head>
<body>

    <!-- CUSTOM ALERT MODAL -->
    <div id="modal-overlay">
        <div class="custom-box">
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>

    <!-- LOBBY -->
    <div id="lobby">
        <div class="lobby-card">
            <h2 style="text-align:center; margin-top:0; color:white;">VoiceHub <span style="color:var(--admin)">PRO</span></h2>
            
            <div class="toggle-capsule">
                <div class="toggle-opt active" onclick="setMode('guest')" id="tab-guest">Participate</div>
                <div class="toggle-opt" onclick="setMode('admin')" id="tab-admin">Admin Command</div>
            </div>

            <!-- GUEST -->
            <div id="form-guest">
                <input type="text" id="g-name" placeholder="Display Name">
                <input type="text" id="g-room" placeholder="Room ID">
                <button class="primary" style="width:100%" onclick="initJoin('guest')">Join Room</button>
            </div>

            <!-- ADMIN -->
            <div id="form-admin" class="hidden">
                <input type="email" id="a-email" placeholder="admin@system.com">
                <input type="password" id="a-pass" placeholder="Password">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="a-room" placeholder="Room ID">
                    <button style="width:50px; margin-bottom:15px;" onclick="document.getElementById('a-room').value = Math.random().toString(36).substr(2,5).toUpperCase()"><i class="fas fa-dice"></i></button>
                </div>
                <button class="admin-gold" style="width:100%" onclick="initJoin('admin')">Authenticate & Host</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-layout" class="hidden">
        
        <!-- Top Bar -->
        <div id="top-bar">
            <div style="display:flex; align-items:center; gap:12px;">
                <div style="font-weight:800; font-size:20px;" id="room-badge">---</div>
                <div id="rec-badge" class="status-badge status-rec hidden"><i class="fas fa-circle"></i> REC</div>
                <div id="lock-badge" class="status-badge hidden" style="background:var(--accent); color:white;"><i class="fas fa-lock"></i> LOCKED</div>
            </div>
            <button class="icon-btn" onclick="copyRoom()" style="width:40px; height:40px;"><i class="fas fa-link"></i></button>
        </div>

        <!-- Admin Only Toolbar -->
        <div id="admin-tools" class="admin-bar hidden">
            <span class="admin-label">Admin Controls:</span>
            <button class="admin-gold" style="padding: 6px 12px; font-size:11px;" onclick="toggleRecording()"><i class="fas fa-record-vinyl"></i> Record Call</button>
            <button class="danger" style="padding: 6px 12px; font-size:11px;" onclick="muteAll()"><i class="fas fa-microphone-slash"></i> Mute All</button>
            <button class="danger" style="padding: 6px 12px; font-size:11px;" onclick="toggleLock()"><i class="fas fa-lock"></i> Lock Room</button>
            <button class="danger" style="padding: 6px 12px; font-size:11px;" onclick="nukeRoom()"><i class="fas fa-skull"></i> End Meeting</button>
        </div>

        <div id="grid">
            <!-- Nodes injected here -->
        </div>

        <div id="controls">
            <button class="icon-btn primary" id="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
            <button class="icon-btn" onclick="toggleScreen()"><i class="fas fa-desktop"></i></button>
            <button class="icon-btn danger" onclick="location.reload()"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, deleteDoc, addDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // !!! IMPORTANT: Replace with your actual Firebase Config !!!
        const firebaseConfig = {
            apiKey: "AIzaSyB8rID7RGFq4iLkueeJsoYYyJ_aAh7qBHs",
            authDomain: "voice-call-demo-1201b.firebaseapp.com",
            projectId: "voice-call-demo-1201b",
            storageBucket: "voice-call-demo-1201b.firebasestorage.app",
            messagingSenderId: "611354192250",
            appId: "1:611354192250:web:bac02535d65ca6565fcec3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE ---
        const state = {
            uid: Math.random().toString(36).substr(2, 9),
            room: null,
            name: 'User',
            role: 'guest',
            joinedAt: Date.now(),
            localStream: null,
            micOn: true,
            pcs: {},
            audioCtx: null,
            mixedDest: null, // Virtual node for recording mixing
            mediaRecorder: null,
            chunks: []
        };
        
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // --- CUSTOM ALERT SYSTEM ---
        function showModal(title, body, actions) {
            return new Promise(resolve => {
                const ol = document.getElementById('modal-overlay');
                const t = document.getElementById('modal-title');
                const b = document.getElementById('modal-body');
                const a = document.getElementById('modal-actions');
                
                t.innerHTML = title; b.innerHTML = body; a.innerHTML = '';

                actions.forEach(act => {
                    const btn = document.createElement('button');
                    btn.innerText = act.text;
                    btn.className = act.class || '';
                    btn.onclick = () => {
                        ol.classList.remove('active');
                        resolve(act.val);
                    };
                    a.appendChild(btn);
                });
                ol.classList.add('active');
            });
        }

        window.customAlert = (msg, title="Notification") => showModal(title, msg, [{text:'Okay', val:true, class:'primary'}]);
        window.customConfirm = (msg, title="Confirm Action") => showModal(title, msg, [{text:'Cancel', val:false}, {text:'Confirm', val:true, class:'danger'}]);

        // --- LOBBY LOGIC ---
        window.setMode = (mode) => {
            document.querySelectorAll('.toggle-opt').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            document.getElementById('form-guest').classList.toggle('hidden', mode !== 'guest');
            document.getElementById('form-admin').classList.toggle('hidden', mode !== 'admin');
        }

        window.initJoin = async (mode) => {
            let room, name;
            
            if(mode === 'admin') {
                const email = document.getElementById('a-email').value;
                const pass = document.getElementById('a-pass').value;
                room = document.getElementById('a-room').value.trim().toUpperCase();
                
                if(!email || !pass || !room) return customAlert("Please fill in all credentials.");

                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                    state.uid = auth.currentUser.uid;
                    state.role = 'admin';
                    state.name = "Host (Admin)";
                } catch(e) { return customAlert(e.message, "Login Failed"); }
            } else {
                name = document.getElementById('g-name').value;
                room = document.getElementById('g-room').value.trim().toUpperCase();
                if(!name || !room) return customAlert("Please enter Name and Room ID.");
                state.role = 'guest';
                state.name = name;
            }

            state.room = room;
            await enterRoom();
        }

        async function enterRoom() {
            try {
                // 1. Audio Setup
                state.localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                setupAudioEngine(); // Setup Context & Mixer

                // 2. Room Check
                const roomRef = doc(db, 'rooms', state.room);
                const roomSnap = await getDoc(roomRef);
                
                if(!roomSnap.exists()) {
                    await setDoc(roomRef, { created: serverTimestamp(), locked: false });
                } else {
                    if(roomSnap.data().locked && state.role !== 'admin') {
                        return customAlert("This room is currently LOCKED by the Host.", "Access Denied");
                    }
                }

                // 3. UI Switch
                document.getElementById('lobby').classList.add('hidden');
                document.getElementById('app-layout').classList.remove('hidden');
                document.getElementById('room-badge').innerText = state.room;
                if(state.role === 'admin') document.getElementById('admin-tools').classList.remove('hidden');

                // 4. Firebase Entry
                const userRef = doc(db, 'rooms', state.room, 'participants', state.uid);
                await setDoc(userRef, {
                    name: state.name,
                    role: state.role,
                    micOn: true,
                    joinedAt: serverTimestamp()
                });

                // Add Self to Grid
                addNode(state.uid, { name: state.name, role: state.role }, true);

                // Start Listeners
                startFirestoreListeners();

            } catch(e) { console.error(e); customAlert("Mic access denied or error occurred.", "System Error"); }
        }

        // --- AUDIO ENGINE (RECORDING MIXER) ---
        function setupAudioEngine() {
            state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            state.mixedDest = state.audioCtx.createMediaStreamDestination(); // The "Tape Recorder" input

            // Add local mic to mixer (so admin is recorded too)
            const localSrc = state.audioCtx.createMediaStreamSource(state.localStream);
            localSrc.connect(state.mixedDest); 
        }

        function connectRemoteAudio(stream, pid) {
            // 1. Create Audio Element for Hearing
            let aud = document.getElementById(`aud-${pid}`);
            if(!aud) {
                aud = document.createElement('audio');
                aud.id = `aud-${pid}`;
                aud.autoplay = true;
                document.body.appendChild(aud);
            }
            aud.srcObject = stream;

            // 2. Route to Mixer (If Admin) for Recording
            if(state.role === 'admin' && state.audioCtx) {
                const src = state.audioCtx.createMediaStreamSource(stream);
                src.connect(state.mixedDest); // Send to recorder
                src.connect(state.audioCtx.destination); // Send to speakers (hearing)
                // Note: direct srcObject on <audio> usually handles speakers, but WebAudio graph gives more control
            }

            // 3. Visualizer
            monitorAudio(stream, pid);
        }

        // --- ADMIN FEATURES ---
        
        window.toggleRecording = async () => {
            if(state.role !== 'admin') return;
            
            if(state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                state.mediaRecorder.stop();
                document.getElementById('rec-badge').classList.add('hidden');
                await customAlert("Recording stopped. File will download shortly.", "Recording Saved");
            } else {
                if(await customConfirm("Start recording call audio?", "Record Meeting")) {
                    // Record the mixed destination stream
                    state.mediaRecorder = new MediaRecorder(state.mixedDest.stream);
                    state.chunks = [];
                    
                    state.mediaRecorder.ondataavailable = e => state.chunks.push(e.data);
                    state.mediaRecorder.onstop = () => {
                        const blob = new Blob(state.chunks, { type: 'audio/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url; a.download = `VoiceHub-Rec-${Date.now()}.webm`;
                        a.click();
                    };
                    
                    state.mediaRecorder.start();
                    document.getElementById('rec-badge').classList.remove('hidden');
                }
            }
        };

        window.toggleLock = async () => {
            const ref = doc(db, 'rooms', state.room);
            const snap = await getDoc(ref);
            const isLocked = snap.data().locked || false;
            await updateDoc(ref, { locked: !isLocked });
            customAlert(!isLocked ? "Room is now LOCKED." : "Room is UNLOCKED.", "Security");
        };

        window.muteAll = async () => {
            if(await customConfirm("Mute everyone else in the room?", "Global Mute")) {
                // Not ideal for massive rooms (too many writes), but fine for small/medium
                // Iterate locally known users (simplified) or trigger a flag on the room doc
                // Here we iterate local collection snapshot (simplified)
                // Ideally, clients listen to a room-level 'muteAllTimestamp'
                // But let's do the individual write for now:
                for(let pid in state.pcs) {
                    await updateDoc(doc(db, 'rooms', state.room, 'participants', pid), { forceMute: true });
                }
                customAlert("Mute command sent.");
            }
        };

        window.nukeRoom = async () => {
            if(await customConfirm("End meeting and kick everyone?", "DANGER")) {
                await updateDoc(doc(db, 'rooms', state.room), { status: 'ended' });
            }
        };
        
        window.kickUser = async (pid) => {
            if(await customConfirm("Kick this user?", "Moderation")) {
                await updateDoc(doc(db, 'rooms', state.room, 'participants', pid), { kicked: true });
            }
        };

        // --- FIRESTORE LISTENERS ---
        function startFirestoreListeners() {
            // Room Meta
            onSnapshot(doc(db, 'rooms', state.room), snap => {
                const d = snap.data();
                if(!d) return;
                if(d.status === 'ended') {
                    customAlert("Meeting ended by host.", "Disconnected").then(() => location.reload());
                }
                document.getElementById('lock-badge').classList.toggle('hidden', !d.locked);
            });

            // Participants
            onSnapshot(collection(db, 'rooms', state.room, 'participants'), snap => {
                snap.docChanges().forEach(change => {
                    const d = change.doc.data();
                    const pid = change.doc.id;
                    
                    if(pid === state.uid) {
                        if(d.kicked) location.reload();
                        if(d.forceMute && state.micOn) {
                             toggleMic(false);
                             customAlert("You were muted by the Admin.", "Alert");
                             updateDoc(doc(db, 'rooms', state.room, 'participants', state.uid), { forceMute: false });
                        }
                        return;
                    }

                    if(change.type === 'added') {
                        addNode(pid, d, false);
                        // Timestamp Authority fix
                        const myTime = state.joinedAt;
                        const theirTime = d.joinedAt ? d.joinedAt.toMillis() : Date.now();
                        if(myTime < theirTime || (Math.abs(myTime - theirTime) < 1000 && state.uid < pid)) {
                            initPeer(pid, true);
                        }
                    }
                    if(change.type === 'modified') updateNode(pid, d);
                    if(change.type === 'removed') removeNode(pid);
                });
            });

            // Signals
            onSnapshot(collection(db, 'rooms', state.room, 'participants', state.uid, 'inbox'), snap => {
                snap.docChanges().forEach(change => {
                    if(change.type === 'added') {
                        handleSignal(change.doc.data());
                        deleteDoc(change.doc.ref);
                    }
                });
            });
        }

        // --- WEBRTC ---
        async function initPeer(pid, initiator) {
            const pc = new RTCPeerConnection(rtcConfig);
            state.pcs[pid] = pc;

            state.localStream.getTracks().forEach(t => pc.addTrack(t, state.localStream));

            pc.onicecandidate = e => {
                if(e.candidate) sendSignal(pid, { type: 'candidate', candidate: e.candidate.toJSON() });
            };

            pc.ontrack = e => {
                if(e.track.kind === 'audio') connectRemoteAudio(e.streams[0], pid);
                if(e.track.kind === 'video') handleScreenShare(e.streams[0], pid);
            };

            if(initiator) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                sendSignal(pid, { type: 'offer', sdp: offer.sdp });
            }
        }

        async function handleSignal(data) {
            let pc = state.pcs[data.from];
            if(!pc) { // Answerer side creation
                await initPeer(data.from, false);
                pc = state.pcs[data.from];
            }

            if(data.type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription(data));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                sendSignal(data.from, { type: 'answer', sdp: answer.sdp });
            } else if(data.type === 'answer') {
                await pc.setRemoteDescription(new RTCSessionDescription(data));
            } else if(data.type === 'candidate') {
                if(pc.remoteDescription) await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        }

        async function sendSignal(target, payload) {
            payload.from = state.uid;
            await addDoc(collection(db, 'rooms', state.room, 'participants', target, 'inbox'), payload);
        }

        // --- DOM ---
        function addNode(id, data, isSelf) {
            const div = document.createElement('div');
            div.className = `node ${data.role==='admin'?'admin-node':''}`;
            div.id = `node-${id}`;
            
            let overlay = '';
            if(state.role === 'admin' && !isSelf) {
                overlay = `
                    <div class="node-overlay">
                        <button class="danger" style="font-size:10px; padding:4px 8px;" onclick="kickUser('${id}')">KICK</button>
                    </div>`;
            }

            div.innerHTML = `
                ${overlay}
                <div class="avatar">${data.name[0]}</div>
                <div style="font-weight:700; font-size:14px; z-index:2;">${data.name}</div>
                <div style="font-size:11px; color:#94a3b8; z-index:2;">${data.role.toUpperCase()}</div>
            `;
            document.getElementById('grid').appendChild(div);
        }

        function updateNode(id, data) {
            // Visual updates (mic icon, etc) can go here
        }

        function removeNode(id) {
            const el = document.getElementById(`node-${id}`);
            if(el) el.remove();
            if(state.pcs[id]) { state.pcs[id].close(); delete state.pcs[id]; }
        }

        function handleScreenShare(stream, pid) {
            const node = document.getElementById(`node-${pid}`);
            const vid = document.createElement('video');
            vid.srcObject = stream;
            vid.autoplay = true; vid.style.cssText = "position:absolute; inset:0; width:100%; height:100%; object-fit:cover;";
            node.appendChild(vid);
        }

        // --- UTILS ---
        window.toggleMic = async (force) => {
            const newVal = force !== undefined ? force : !state.micOn;
            state.micOn = newVal;
            state.localStream.getAudioTracks()[0].enabled = state.micOn;
            
            const btn = document.getElementById('btn-mic');
            btn.innerHTML = state.micOn ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
            btn.classList.toggle('primary', state.micOn);
            btn.classList.toggle('danger', !state.micOn);
            
            await updateDoc(doc(db, 'rooms', state.room, 'participants', state.uid), { micOn: state.micOn });
        };

        window.copyRoom = () => {
            navigator.clipboard.writeText(state.room);
            customAlert("Room ID copied to clipboard.");
        }

        function monitorAudio(stream, id) {
            const src = state.audioCtx.createMediaStreamSource(stream);
            const anl = state.audioCtx.createAnalyser();
            anl.fftSize = 32; src.connect(anl);
            const data = new Uint8Array(anl.frequencyBinCount);
            
            const iv = setInterval(() => {
                const el = document.getElementById(`node-${id}`);
                if(!el) { clearInterval(iv); return; }
                anl.getByteFrequencyData(data);
                const vol = data.reduce((a,b)=>a+b)/data.length;
                if(vol > 20) el.classList.add('speaking');
                else el.classList.remove('speaking');
            }, 100);
        }

    </script>
</body>
</html>
